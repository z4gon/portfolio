<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Metal Render Pipeline Part 11: 3D Perspective Projection Matrix</title><meta name="title" content="Metal Render Pipeline Part 11: 3D Perspective Projection Matrix"/><meta name="description" content="Setting up the the 3D perspective projection matrix to transform view space coordinates in homogeneous clip space coordinates. Later on the GPU takes in these and calculates the Normalized Device Coordinates, to finally calculate the actual Screen Space coordinates. Configuring the Depth Stencil in Metal, to perform Depth Testing and clipping based on depth, using the Depth Texture. Multiplying the projection matrix by the view space coordinates vector during the Vertex Shader Function stage."/><meta property="og:type" content="website"/><meta property="og:url" content="https://z4gon.github.io/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix"/><meta property="og:title" content="Metal Render Pipeline Part 11: 3D Perspective Projection Matrix"/><meta property="og:description" content="Setting up the the 3D perspective projection matrix to transform view space coordinates in homogeneous clip space coordinates. Later on the GPU takes in these and calculates the Normalized Device Coordinates, to finally calculate the actual Screen Space coordinates. Configuring the Depth Stencil in Metal, to perform Depth Testing and clipping based on depth, using the Depth Texture. Multiplying the projection matrix by the view space coordinates vector during the Vertex Shader Function stage."/><meta property="og:image" content="https://z4gon.github.io/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/cover.jpg"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:url" content="https://z4gon.github.io/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix"/><meta property="twitter:title" content="Metal Render Pipeline Part 11: 3D Perspective Projection Matrix"/><meta property="twitter:description" content="Setting up the the 3D perspective projection matrix to transform view space coordinates in homogeneous clip space coordinates. Later on the GPU takes in these and calculates the Normalized Device Coordinates, to finally calculate the actual Screen Space coordinates. Configuring the Depth Stencil in Metal, to perform Depth Testing and clipping based on depth, using the Depth Texture. Multiplying the projection matrix by the view space coordinates vector during the Vertex Shader Function stage."/><meta property="twitter:image" content="https://z4gon.github.io/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/cover.jpg"/><link rel="icon" href="https://z4gon.github.io/favicon.ico"/><link rel="canonical" href="https://z4gon.github.io/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix"/><meta name="next-head-count" content="17"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/1bfb3b4d6930f464.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1bfb3b4d6930f464.css" data-n-g=""/><link rel="preload" href="/_next/static/css/7f11fd614ca16a3e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7f11fd614ca16a3e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-010ff0b6bbe5ac8f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a7128038526bd4a3.js" defer=""></script><script src="/_next/static/chunks/151-c7a4603d5dcabdf0.js" defer=""></script><script src="/_next/static/chunks/358-14c60bb94e9d94b9.js" defer=""></script><script src="/_next/static/chunks/473-98aebf76c15b7921.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-15411d051870c892.js" defer=""></script><script src="/_next/static/wvZXsXRVXQrHYwWRs-6Uo/_buildManifest.js" defer=""></script><script src="/_next/static/wvZXsXRVXQrHYwWRs-6Uo/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,500;0,700;1,300;1,500&display=swap">@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memQYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWq8tWZ0Pw86hd0Rk5hkaVQ.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memQYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWq8tWZ0Pw86hd0Rk_RkaVQ.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsiH0C4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjr0C4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsg-1y4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtE6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWvU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWu06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWt06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuU6FxZCJgg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtE6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWvU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWu06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWt06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuU6FxZCJgg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v34/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="Page_page__0A7TG"><nav class="NavBar_navbar__W8B89"><ul class="NavBar_links__s6P8N"><li><a class="NavBar_titleLink__OtPh0" href="/"><h1>Gonzalo Cumini</h1></a></li><li class="NavBar_secondaryLink__TpgXh"><a href="/"><h1>Portfolio</h1></a></li><li class="NavBar_secondaryLink__TpgXh"><a href="/blog"><h1>Blog</h1></a></li></ul><ul class="NavBar_icons__Q_6kO"><li class="NavBar_icon__MjYq8"><a href="https://linkedin.com/in/gonzacn" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li><li class="NavBar_icon__MjYq8"><a href="https://github.com/z4gon" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li></ul></nav><main class="Container_container__B4HQR Container_narrow__Miio9"><div style="padding-top:3.5em"></div><article><div class="PostHeader_postHeader__aw96i"><h1 class="PostTitle_postTitle__oD_V4">Metal Render Pipeline Part 11: 3D Perspective Projection Matrix</h1><div class="PostHeader_authorAndDate__tbJVE"><div class="Avatar_avatar__G9F0L"><img src="/images/avatars/z4gon.jpg" alt="Gonzalo Cumini"/><div class="Avatar_name__yGpBe">Gonzalo Cumini</div></div><time class="DateFormatter_dateFormatter__UBCZJ" dateTime="2022-12-29T00:00:00.000Z">December	29, 2022</time></div><video muted="" playsinline="" controls="" class="PostHeader_coverVideo__CTucm"><source src="/videos/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/1.mp4" type="video/mp4"/></video></div><div class="MarkdownContent_markdownContent__TdwXL"><h2 id="source-code">Source Code</h2>
<p><a href="https://github.com/z4gon/metal-render-pipeline">See Project in GitHub üë©‚Äçüíª</a></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.youtube.com/playlist?list=PLEXt1-oJUa4BVgjZt9tK2MhV_DW7PVDsg">Metal Render Pipeline tutorial series by Rick Twohy</a></li>
<li><a href="https://gamedev.stackexchange.com/questions/120338/what-does-a-perspective-projection-matrix-look-like-in-opengl">3D Perspective Projection Matrix</a></li>
<li><a href="https://webglfundamentals.org/webgl/lessons/webgl-3d-perspective.html">3D Perspective Projection Matrix in Action</a></li>
<li><a href="https://glumpy.readthedocs.io/en/latest/tutorial/cube-ugly.html">Projecting a Cube</a></li>
<li><a href="https://developer.apple.com/documentation/metal/render_passes/calculating_primitive_visibility_using_depth_testing">Calculating Primitive Visibility Using Depth Testing</a></li>
<li><a href="https://www.youtube.com/watch?v=pThw0S8MR7w">OpenGL - clip space, NDC, and screen space</a></li>
</ul>
<hr/>
<h2 id="table-of-content">Table of Content</h2>
<ul>
<li><a href="#3d-perspective-projection-matrix">3D Perspective Projection Matrix</a>
<ul>
<li><a href="#view-frustrum">View Frustrum</a></li>
<li><a href="#clipping">Clipping</a></li>
<li><a href="#matrix">Matrix</a></li>
</ul>
</li>
<li><a href="#cube-mesh">Cube Mesh</a></li>
<li><a href="#depth-stencil">Depth Stencil</a>
<ul>
<li><a href="#descriptor">Descriptor</a></li>
<li><a href="#state">State</a></li>
<li><a href="#pixel-format">Pixel Format</a></li>
</ul>
</li>
<li><a href="#mesh-renderer">Mesh Renderer</a></li>
<li><a href="#camera">Camera</a></li>
<li><a href="#scene">Scene</a></li>
<li><a href="#shader">Shader</a></li>
</ul>
<hr/>
<h2 id="3d-perspective-projection-matrix">3D Perspective Projection Matrix</h2>
<h3 id="view-frustrum">View Frustrum</h3>
<p>Projecting 3D objects onto a flat surface means connecting each vertex to the position of the camera, and pin pointing where that line crosses the near clip plane.</p>
<p><img src="/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/1.jpg" alt="Picture"/></p>
<p><a href="https://glumpy.readthedocs.io/en/latest/tutorial/cube-ugly.html">Image Source üîó</a></p>
<h3 id="clipping">Clipping</h3>
<p>The near and far clip planes determine what gets rendered in terms of depth.</p>
<p>The field of view means how much stuff gets into the projection in terms of bounds vertically and horizontally.</p>
<p><img src="/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/2.jpg" alt="Picture"/></p>
<p><a href="https://webglfundamentals.org/webgl/lessons/webgl-3d-perspective.html">Image Source üîó</a></p>
<h3 id="matrix">Matrix</h3>
<p>All the calculations can be put into a pre-determined matrix that can be multiplied by a position vector and it will return the homogenous clip space coordinates.</p>
<p>Metal will then translate these to Normalized Device Coordinates ranging from (-1, -1) to (1, 1) and including depth.</p>
<p>Finally this will be translated to screen space as x, y coordinates in pixels.</p>
<p><img src="/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/3.jpg" alt="Picture"/></p>
<p><a href="https://gamedev.stackexchange.com/questions/120338/what-does-a-perspective-projection-matrix-look-like-in-opengl">Image Source üîó</a></p>
<p>This is what it looks like in code:</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span style="font-weight:bold">mutating</span><span> </span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">projectPerspective</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">fieldOfView</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">Float</span><span class="hljs-function">, </span><span class="hljs-function hljs-params">aspectRatio</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">Float</span><span class="hljs-function">, </span><span class="hljs-function hljs-params">farClippingDistance</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">Float</span><span class="hljs-function">, </span><span class="hljs-function hljs-params">nearClippingDistance</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">Float</span><span class="hljs-function">)</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span>    </span><span style="font-weight:bold">var</span><span> result </span><span class="hljs-operator">=</span><span> matrix_identity_float4x4
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span><span>    </span><span style="font-weight:bold">let</span><span> fov </span><span class="hljs-operator">=</span><span> fieldOfView
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span><span>    </span><span style="font-weight:bold">let</span><span> aspect </span><span class="hljs-operator">=</span><span> aspectRatio
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span><span>    </span><span style="font-weight:bold">let</span><span> far </span><span class="hljs-operator">=</span><span> farClippingDistance
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span>    </span><span style="font-weight:bold">let</span><span> near </span><span class="hljs-operator">=</span><span> nearClippingDistance
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>    result.columns </span><span class="hljs-operator">=</span><span> (
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span><span>        float4(</span><span style="color:#880000">Float</span><span>(</span><span style="color:#880000">1</span><span>) </span><span class="hljs-operator">/</span><span> ( aspect </span><span class="hljs-operator">*</span><span> tan(fov </span><span class="hljs-operator">/</span><span> </span><span style="color:#880000">Float</span><span>(</span><span style="color:#880000">2</span><span>)) ), </span><span style="color:#880000">0</span><span>, </span><span style="color:#880000">0</span><span>, </span><span style="color:#880000">0</span><span>),
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span>        float4(</span><span style="color:#880000">0</span><span>, </span><span style="color:#880000">Float</span><span>(</span><span style="color:#880000">2</span><span>) </span><span class="hljs-operator">/</span><span> tan(fov </span><span class="hljs-operator">/</span><span> </span><span style="color:#880000">Float</span><span>(</span><span style="color:#880000">2</span><span>)), </span><span style="color:#880000">0</span><span>, </span><span style="color:#880000">0</span><span>),
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span>        float4(</span><span style="color:#880000">0</span><span>, </span><span style="color:#880000">0</span><span>, </span><span class="hljs-operator">-</span><span>((far </span><span class="hljs-operator">+</span><span> near)</span><span class="hljs-operator">/</span><span>(far </span><span class="hljs-operator">-</span><span> near)), </span><span class="hljs-operator">-</span><span style="color:#880000">1</span><span>),
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span>        float4(</span><span style="color:#880000">0</span><span>, </span><span style="color:#880000">0</span><span>, </span><span class="hljs-operator">-</span><span>((</span><span style="color:#880000">2</span><span> </span><span class="hljs-operator">*</span><span> far </span><span class="hljs-operator">*</span><span> near)</span><span class="hljs-operator">/</span><span>(far </span><span class="hljs-operator">-</span><span> near)), </span><span style="color:#880000">0</span><span>)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span>    )
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span>    </span><span style="font-weight:bold">self</span><span> </span><span class="hljs-operator">=</span><span> matrix_multiply(</span><span style="font-weight:bold">self</span><span>, result)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span>}</code></div></pre>
<hr/>
<h2 id="cube-mesh">Cube Mesh</h2>
<p>To define a cube mesh, we need just 8 vertices.</p>
<p>And then an array of indexes to define all the counter clockwise triangles that will make up the quad faces.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="hljs-class" style="font-weight:bold">class</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">CubeMesh</span><span class="hljs-class"> : </span><span class="hljs-class" style="color:#880000;font-weight:bold">Mesh</span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span>    </span><span style="font-weight:bold">override</span><span> </span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">createMesh</span><span class="hljs-function">()</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span>        vertices </span><span class="hljs-operator">=</span><span> [
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3( </span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>)), </span><span style="color:#888888">// FRONT Top Right</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3(</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>)), </span><span style="color:#888888">// FRONT Top Left</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3(</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>,</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">1</span><span>)), </span><span style="color:#888888">// FRONT Bottom Left</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3( </span><span style="color:#880000">0.5</span><span>,</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">1</span><span>)),  </span><span style="color:#888888">// FRONT Bottom Right</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3( </span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>, </span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">1</span><span>)), </span><span style="color:#888888">// BACK Top Right</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3(</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>, </span><span style="color:#880000">0.5</span><span>, </span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">1</span><span>)), </span><span style="color:#888888">// BACK Top Left</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3(</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>,</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>, </span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>)), </span><span style="color:#888888">// BACK Bottom Left</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span>            </span><span style="color:#880000">Vertex</span><span>(position: float3( </span><span style="color:#880000">0.5</span><span>,</span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>, </span><span class="hljs-operator">-</span><span style="color:#880000">0.5</span><span>), color: float4(</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>))  </span><span style="color:#888888">// BACK Bottom Right</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span>        ]
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span>        </span><span style="color:#888888">// counter clockwise mean out facing</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span>        indices </span><span class="hljs-operator">=</span><span> [
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span><span>            </span><span style="color:#888888">// FRONT face</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span><span>            </span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">2</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">20</span><span>            </span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">2</span><span>,</span><span style="color:#880000">3</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">21</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">22</span><span>            </span><span style="color:#888888">// BACK face</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">23</span><span>            </span><span style="color:#880000">5</span><span>,</span><span style="color:#880000">4</span><span>,</span><span style="color:#880000">7</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">24</span><span>            </span><span style="color:#880000">5</span><span>,</span><span style="color:#880000">7</span><span>,</span><span style="color:#880000">6</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">25</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">26</span><span>            </span><span style="color:#888888">// TOP face</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">27</span><span>            </span><span style="color:#880000">4</span><span>,</span><span style="color:#880000">5</span><span>,</span><span style="color:#880000">1</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">28</span><span>            </span><span style="color:#880000">4</span><span>,</span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">0</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">29</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">30</span><span>            </span><span style="color:#888888">// BOTTOM face</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">31</span><span>            </span><span style="color:#880000">6</span><span>,</span><span style="color:#880000">7</span><span>,</span><span style="color:#880000">3</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">32</span><span>            </span><span style="color:#880000">6</span><span>,</span><span style="color:#880000">3</span><span>,</span><span style="color:#880000">2</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">33</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">34</span><span>            </span><span style="color:#888888">// LEFT face</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">35</span><span>            </span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">5</span><span>,</span><span style="color:#880000">6</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">36</span><span>            </span><span style="color:#880000">1</span><span>,</span><span style="color:#880000">6</span><span>,</span><span style="color:#880000">2</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">37</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">38</span><span>            </span><span style="color:#888888">// RIGHT face</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">39</span><span>            </span><span style="color:#880000">4</span><span>,</span><span style="color:#880000">0</span><span>,</span><span style="color:#880000">3</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">40</span><span>            </span><span style="color:#880000">4</span><span>,</span><span style="color:#880000">3</span><span>,</span><span style="color:#880000">7</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">41</span>        ]
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">42</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">43</span>}</code></div></pre>
<hr/>
<h2 id="depth-stencil">Depth Stencil</h2>
<h3 id="descriptor">Descriptor</h3>
<p>To let the <strong>GPU</strong> know what vertices are <strong>farther away</strong> from the <strong>camera</strong>, and then be able to clip them using the <strong>Depth Test</strong>, we need to setup the <strong>Depth Stencil Descriptor</strong>.</p>
<h3 id="state">State</h3>
<p>We will use the descriptor to create the <strong>Depth Stencil State</strong>, and pass it on to the <strong>Render Command Encoder</strong>.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span style="font-weight:bold">public</span><span> </span><span class="hljs-class" style="font-weight:bold">struct</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">LessDepthStencilState</span><span class="hljs-class">: </span><span class="hljs-class" style="color:#880000;font-weight:bold">DepthStencilState</span><span class="hljs-class"> </span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span>    </span><span style="font-weight:bold">var</span><span> name: </span><span style="color:#880000">String</span><span> </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">&quot;Less DepthTest&quot;</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span>    </span><span style="font-weight:bold">var</span><span> depthStencilState: </span><span style="color:#880000">MTLDepthStencilState</span><span>!
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span>    </span><span class="hljs-function" style="font-weight:bold">init</span><span class="hljs-function">()</span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span>        </span><span style="font-weight:bold">let</span><span> depthStencilDescriptor </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">MTLDepthStencilDescriptor</span><span>()
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span>        depthStencilDescriptor.depthCompareFunction </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">MTLCompareFunction</span><span>.less
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>        depthStencilDescriptor.isDepthWriteEnabled </span><span class="hljs-operator">=</span><span> </span><span style="color:#78A960">true</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span>        depthStencilState </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">Engine</span><span>.device.makeDepthStencilState(descriptor: depthStencilDescriptor)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>}</code></div></pre>
<h3 id="pixel-format">Pixel Format</h3>
<p>The <strong>Render Pipeline Descriptor</strong> and the <strong>MTKView</strong> will both need to set the <strong>Depth Stencil Pixel Format</strong> as well, just like they set the <strong>Color Pixel Format</strong>.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span style="font-weight:bold">public</span><span> </span><span class="hljs-class" style="font-weight:bold">struct</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">BasicRenderPipelineDescriptor</span><span class="hljs-class">: </span><span class="hljs-class" style="color:#880000;font-weight:bold">RenderPipelineDescriptor</span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span>    </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span>    </span><span class="hljs-function" style="font-weight:bold">init</span><span class="hljs-function">()</span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span>        </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span>        </span><span style="color:#888888">// make the pixel format match the device</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>        renderPipelineDescriptor.colorAttachments[</span><span style="color:#880000">0</span><span>].pixelFormat </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">Preferences</span><span>.</span><span style="color:#880000">PixelFormat</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span>        renderPipelineDescriptor.depthAttachmentPixelFormat </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">Preferences</span><span>.</span><span style="color:#880000">DepthStencilPixelFormat</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span>        </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span>}</code></div></pre>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="hljs-class" style="font-weight:bold">class</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">GameView</span><span class="hljs-class">: </span><span class="hljs-class" style="color:#880000;font-weight:bold">MTKView</span><span class="hljs-class"> </span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span>    </span><span style="font-weight:bold">var</span><span> renderer: </span><span style="color:#880000">GameViewRenderer</span><span>!
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span>    </span><span style="font-weight:bold">required</span><span> </span><span class="hljs-function" style="font-weight:bold">init</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">coder</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">NSCoder</span><span class="hljs-function">)</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span>        </span><span style="font-weight:bold">super</span><span>.</span><span style="font-weight:bold">init</span><span>(coder: coder)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span>        device </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">MTLCreateSystemDefaultDevice</span><span>()
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>        clearColor </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">Preferences</span><span>.</span><span style="color:#880000">ClearColor</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span>        colorPixelFormat </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">Preferences</span><span>.</span><span style="color:#880000">PixelFormat</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span>        depthStencilPixelFormat </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">Preferences</span><span>.</span><span style="color:#880000">DepthStencilPixelFormat</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span>        </span><span style="color:#880000">Engine</span><span>.initialize(device: device</span><span class="hljs-operator">!</span><span>)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span>        renderer </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">GameViewRenderer</span><span>(</span><span style="font-weight:bold">self</span><span>)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span>        delegate </span><span class="hljs-operator">=</span><span> renderer
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span>}</code></div></pre>
<hr/>
<h2 id="mesh-renderer">Mesh Renderer</h2>
<p>The mesh renderer will pass the <strong>Depth Stencil State</strong> to the <strong>Render Command Encoder</strong>.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">doRender</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">renderCommandEncoder</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">MTLRenderCommandEncoder</span><span class="hljs-function">)</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span>    </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span>    renderCommandEncoder.setDepthStencilState(</span><span style="color:#880000">DepthStencilStateCache</span><span>.getDepthStencilState(.</span><span style="color:#880000">Less</span><span>))
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span>    </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>}</code></div></pre>
<hr/>
<h2 id="camera">Camera</h2>
<p>The camera will use its properties to calculate the <strong>Perspective Projection Matrix</strong>.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="hljs-class" style="font-weight:bold">class</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">Camera</span><span class="hljs-class"> : </span><span class="hljs-class" style="color:#880000;font-weight:bold">Component</span><span class="hljs-class">, </span><span class="hljs-class" style="color:#880000;font-weight:bold">EarlyUpdatable</span><span class="hljs-class"> </span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span>    </span><span style="font-weight:bold">public</span><span> </span><span style="font-weight:bold">var</span><span> viewMatrix: float4x4 </span><span class="hljs-operator">=</span><span> matrix_identity_float4x4
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span>    </span><span style="font-weight:bold">public</span><span> </span><span style="font-weight:bold">var</span><span> projectionMatrix: float4x4 </span><span class="hljs-operator">=</span><span> matrix_identity_float4x4
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span>    </span><span style="font-weight:bold">public</span><span> </span><span style="font-weight:bold">var</span><span> type: </span><span style="color:#880000">CameraType</span><span> </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">CameraType</span><span>.</span><span style="color:#880000">Perspective</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span>    </span><span style="font-weight:bold">public</span><span> </span><span style="font-weight:bold">var</span><span> fieldOfView: </span><span style="color:#880000">Float</span><span> </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">60</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>    </span><span style="font-weight:bold">public</span><span> </span><span style="font-weight:bold">var</span><span> nearClippingDistance: </span><span style="color:#880000">Float</span><span> </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">0.1</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span>    </span><span style="font-weight:bold">public</span><span> </span><span style="font-weight:bold">var</span><span> farClippingDistance: </span><span style="color:#880000">Float</span><span> </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">1000</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span>    </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span>    </span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">updateProjectionMatrix</span><span class="hljs-function">()</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span>        </span><span style="font-weight:bold">var</span><span> result: float4x4 </span><span class="hljs-operator">=</span><span> matrix_identity_float4x4
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span>        </span><span style="font-weight:bold">if</span><span>(type </span><span class="hljs-operator">==</span><span> </span><span style="color:#880000">CameraType</span><span>.</span><span style="color:#880000">Perspective</span><span>) {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span>            result.projectPerspective(
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span>                fieldOfViewDegrees: fieldOfView,
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span>                aspectRatio: </span><span style="color:#880000">GameViewRenderer</span><span>.</span><span style="color:#880000">AspectRatio</span><span>,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>                farClippingDistance: farClippingDistance,
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span>                nearClippingDistance: nearClippingDistance
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span>            )
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span>        }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span>        projectionMatrix </span><span class="hljs-operator">=</span><span> result
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span>    </span><span style="color:#888888">// to ensure all other components get the accurate camera position</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span><span>    </span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">doEarlyUpdate</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">deltaTime</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">Float</span><span class="hljs-function">)</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span>        updateViewMatrix()
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span>        updateProjectionMatrix()
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span>}</code></div></pre>
<hr/>
<h2 id="scene">Scene</h2>
<p>The Scene will include the <strong>projection matrix</strong> in its <strong>Scene Constants</strong> that will get passed down to the <strong>GPU</strong>.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="hljs-class" style="font-weight:bold">class</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">Scene</span><span class="hljs-class"> : </span><span class="hljs-class" style="color:#880000;font-weight:bold">Transform</span><span class="hljs-class"> </span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span>    </span><span style="font-weight:bold">private</span><span> </span><span style="font-weight:bold">var</span><span> _sceneConstants: </span><span style="color:#880000">SceneConstants</span><span>! </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">SceneConstants</span><span>()
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span>    </span><span class="hljs-operator">...</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span>    </span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">updateSceneConstants</span><span class="hljs-function">()</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span>        _sceneConstants.viewMatrix </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">CameraManager</span><span>.mainCamera.viewMatrix
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>        _sceneConstants.projectionMatrix </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">CameraManager</span><span>.mainCamera.projectionMatrix
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span>    </span><span style="font-weight:bold">override</span><span> </span><span class="hljs-function" style="font-weight:bold">func</span><span class="hljs-function"> </span><span class="hljs-function" style="color:#880000;font-weight:bold">render</span><span class="hljs-function">(</span><span class="hljs-function hljs-params">renderCommandEncoder</span><span class="hljs-function">: </span><span class="hljs-function" style="color:#880000">MTLRenderCommandEncoder</span><span class="hljs-function">)</span><span> {
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span>        updateSceneConstants()
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span>        </span><span style="color:#888888">// set the view matrix</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span>        renderCommandEncoder.setVertexBytes(</span><span class="hljs-operator">&amp;</span><span>_sceneConstants, length: </span><span style="color:#880000">SceneConstants</span><span>.stride, index: </span><span style="color:#880000">2</span><span>)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span>        </span><span style="font-weight:bold">super</span><span>.render(renderCommandEncoder: renderCommandEncoder)
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span>    }
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>}</code></div></pre>
<hr/>
<h2 id="shader">Shader</h2>
<p>In the Shader code, we will use the <strong>projection matrix</strong> to multiply it by the rest of the matrices and the position, to complete the transformation of the coordinates into <strong>homogenous clip space</strong>.</p>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-c" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span>float4 HCPosition = ProjMatrix * ViewMatrix * ModelMatrix * objectPosition;</span></code></div></pre>
<pre><div style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code class="language-swift" style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="hljs-class" style="font-weight:bold">struct</span><span class="hljs-class"> </span><span class="hljs-class" style="color:#880000;font-weight:bold">SceneConstants</span><span class="hljs-class"> </span><span>{
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>    float4x4 viewMatrix;
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span>    float4x4 projectionMatrix;
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>};
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span>vertex </span><span style="color:#880000">FragmentData</span><span> basic_vertex_shader(
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span>  </span><span style="color:#888888">// metal can infer the data because we are describing it using the vertex descriptor</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span>  const </span><span style="color:#880000">VertexData</span><span> </span><span style="color:#880000">IN</span><span> [[ stage_in ]],
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span>  constant </span><span style="color:#880000">ModelConstants</span><span> </span><span class="hljs-operator">&amp;</span><span>modelConstants [[ buffer(</span><span style="color:#880000">1</span><span>) ]],
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span>  constant </span><span style="color:#880000">SceneConstants</span><span> </span><span class="hljs-operator">&amp;</span><span>sceneConstants [[ buffer(</span><span style="color:#880000">2</span><span>) ]]
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span>){
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span>    </span><span style="color:#880000">FragmentData</span><span> </span><span style="color:#880000">OUT</span><span>;
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span>    </span><span style="color:#888888">// return the vertex position in homogeneous screen space</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span>    </span><span style="color:#888888">// ProjectionMatrix * ViewMatrix * ModelMatrix * ObjectPosition = HSCPosition</span><span>
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span>    </span><span style="color:#880000">OUT</span><span>.position </span><span class="hljs-operator">=</span><span> sceneConstants.projectionMatrix
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span>                    </span><span class="hljs-operator">*</span><span> sceneConstants.viewMatrix
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span>                    </span><span class="hljs-operator">*</span><span> modelConstants.modelMatrix
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span>                    </span><span class="hljs-operator">*</span><span> float4(</span><span style="color:#880000">IN</span><span>.position, </span><span style="color:#880000">1</span><span>);
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span><span>    </span><span style="color:#880000">OUT</span><span>.color </span><span class="hljs-operator">=</span><span> </span><span style="color:#880000">IN</span><span>.color;
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span><span>    </span><span style="font-weight:bold">return</span><span> </span><span style="color:#880000">OUT</span><span>;
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span>}</code></div></pre>
<hr/>
<h2 id="result">Result</h2>
<p>Now the cube appears projected correctly in the screen space plane.</p>
<p><img src="/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/cover.jpg" alt="Picture"/></p></div></article><div style="padding-top:3.5em"></div></main><footer class="Footer_footer__rEL09"><p>¬©<!-- --> 2023, Gonzalo Cumini</p><ul class="Footer_icons__IyNdc"><li class="Footer_icon__mhtwE"><a href="https://linkedin.com/in/gonzacn" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li><li class="Footer_icon__mhtwE"><a href="https://github.com/z4gon" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li></ul></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"metal-render-pipeline-part-11-3d-perspective-projection-matrix","date":"2022-12-29T00:00:00.000Z","author":{"name":"Gonzalo Cumini","pictureUrl":"/images/avatars/z4gon.jpg"},"title":"Metal Render Pipeline Part 11: 3D Perspective Projection Matrix","excerpt":"Setting up the the 3D perspective projection matrix to transform view space coordinates in homogeneous clip space coordinates. Later on the GPU takes in these and calculates the Normalized Device Coordinates, to finally calculate the actual Screen Space coordinates. Configuring the Depth Stencil in Metal, to perform Depth Testing and clipping based on depth, using the Depth Texture. Multiplying the projection matrix by the view space coordinates vector during the Vertex Shader Function stage.","coverImageUrl":"/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/cover.jpg","coverImageSourceUrl":"","coverVideoUrl":"/videos/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/1.mp4","contentMarkdown":"\n## Source Code\n\n[See Project in GitHub üë©‚Äçüíª](https://github.com/z4gon/metal-render-pipeline)\n\n## References\n\n-   [Metal Render Pipeline tutorial series by Rick Twohy](https://www.youtube.com/playlist?list=PLEXt1-oJUa4BVgjZt9tK2MhV_DW7PVDsg)\n-   [3D Perspective Projection Matrix](https://gamedev.stackexchange.com/questions/120338/what-does-a-perspective-projection-matrix-look-like-in-opengl)\n-   [3D Perspective Projection Matrix in Action](https://webglfundamentals.org/webgl/lessons/webgl-3d-perspective.html)\n-   [Projecting a Cube](https://glumpy.readthedocs.io/en/latest/tutorial/cube-ugly.html)\n-   [Calculating Primitive Visibility Using Depth Testing](https://developer.apple.com/documentation/metal/render_passes/calculating_primitive_visibility_using_depth_testing)\n-   [OpenGL - clip space, NDC, and screen space](https://www.youtube.com/watch?v=pThw0S8MR7w)\n\n---\n\n## Table of Content\n\n-   [3D Perspective Projection Matrix](#3d-perspective-projection-matrix)\n    -   [View Frustrum](#view-frustrum)\n    -   [Clipping](#clipping)\n    -   [Matrix](#matrix)\n-   [Cube Mesh](#cube-mesh)\n-   [Depth Stencil](#depth-stencil)\n    -   [Descriptor](#descriptor)\n    -   [State](#state)\n    -   [Pixel Format](#pixel-format)\n-   [Mesh Renderer](#mesh-renderer)\n-   [Camera](#camera)\n-   [Scene](#scene)\n-   [Shader](#shader)\n\n---\n\n## 3D Perspective Projection Matrix\n\n### View Frustrum\n\nProjecting 3D objects onto a flat surface means connecting each vertex to the position of the camera, and pin pointing where that line crosses the near clip plane.\n\n![Picture](/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/1.jpg)\n\n[Image Source üîó](https://glumpy.readthedocs.io/en/latest/tutorial/cube-ugly.html)\n\n### Clipping\n\nThe near and far clip planes determine what gets rendered in terms of depth.\n\nThe field of view means how much stuff gets into the projection in terms of bounds vertically and horizontally.\n\n![Picture](/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/2.jpg)\n\n[Image Source üîó](https://webglfundamentals.org/webgl/lessons/webgl-3d-perspective.html)\n\n### Matrix\n\nAll the calculations can be put into a pre-determined matrix that can be multiplied by a position vector and it will return the homogenous clip space coordinates.\n\nMetal will then translate these to Normalized Device Coordinates ranging from (-1, -1) to (1, 1) and including depth.\n\nFinally this will be translated to screen space as x, y coordinates in pixels.\n\n![Picture](/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/3.jpg)\n\n[Image Source üîó](https://gamedev.stackexchange.com/questions/120338/what-does-a-perspective-projection-matrix-look-like-in-opengl)\n\nThis is what it looks like in code:\n\n```swift\nmutating func projectPerspective(fieldOfView: Float, aspectRatio: Float, farClippingDistance: Float, nearClippingDistance: Float) {\n    var result = matrix_identity_float4x4\n\n    let fov = fieldOfView\n    let aspect = aspectRatio\n    let far = farClippingDistance\n    let near = nearClippingDistance\n\n    result.columns = (\n        float4(Float(1) / ( aspect * tan(fov / Float(2)) ), 0, 0, 0),\n        float4(0, Float(2) / tan(fov / Float(2)), 0, 0),\n        float4(0, 0, -((far + near)/(far - near)), -1),\n        float4(0, 0, -((2 * far * near)/(far - near)), 0)\n    )\n\n    self = matrix_multiply(self, result)\n}\n```\n\n---\n\n## Cube Mesh\n\nTo define a cube mesh, we need just 8 vertices.\n\nAnd then an array of indexes to define all the counter clockwise triangles that will make up the quad faces.\n\n```swift\nclass CubeMesh : Mesh{\n    override func createMesh() {\n        vertices = [\n            Vertex(position: float3( 0.5, 0.5, 0.5), color: float4(1,0,0,1)), // FRONT Top Right\n            Vertex(position: float3(-0.5, 0.5, 0.5), color: float4(0,1,0,1)), // FRONT Top Left\n            Vertex(position: float3(-0.5,-0.5, 0.5), color: float4(0,0,1,1)), // FRONT Bottom Left\n            Vertex(position: float3( 0.5,-0.5, 0.5), color: float4(1,0,1,1)),  // FRONT Bottom Right\n\n            Vertex(position: float3( 0.5, 0.5, -0.5), color: float4(0,0,1,1)), // BACK Top Right\n            Vertex(position: float3(-0.5, 0.5, -0.5), color: float4(1,0,1,1)), // BACK Top Left\n            Vertex(position: float3(-0.5,-0.5, -0.5), color: float4(1,0,0,1)), // BACK Bottom Left\n            Vertex(position: float3( 0.5,-0.5, -0.5), color: float4(0,1,0,1))  // BACK Bottom Right\n        ]\n\n        // counter clockwise mean out facing\n        indices = [\n\n            // FRONT face\n            0,1,2,\n            0,2,3,\n\n            // BACK face\n            5,4,7,\n            5,7,6,\n\n            // TOP face\n            4,5,1,\n            4,1,0,\n\n            // BOTTOM face\n            6,7,3,\n            6,3,2,\n\n            // LEFT face\n            1,5,6,\n            1,6,2,\n\n            // RIGHT face\n            4,0,3,\n            4,3,7\n        ]\n    }\n}\n```\n\n---\n\n## Depth Stencil\n\n### Descriptor\n\nTo let the **GPU** know what vertices are **farther away** from the **camera**, and then be able to clip them using the **Depth Test**, we need to setup the **Depth Stencil Descriptor**.\n\n### State\n\nWe will use the descriptor to create the **Depth Stencil State**, and pass it on to the **Render Command Encoder**.\n\n```swift\npublic struct LessDepthStencilState: DepthStencilState {\n    var name: String = \"Less DepthTest\"\n    var depthStencilState: MTLDepthStencilState!\n\n    init(){\n\n        let depthStencilDescriptor = MTLDepthStencilDescriptor()\n        depthStencilDescriptor.depthCompareFunction = MTLCompareFunction.less\n        depthStencilDescriptor.isDepthWriteEnabled = true\n\n        depthStencilState = Engine.device.makeDepthStencilState(descriptor: depthStencilDescriptor)\n    }\n}\n```\n\n### Pixel Format\n\nThe **Render Pipeline Descriptor** and the **MTKView** will both need to set the **Depth Stencil Pixel Format** as well, just like they set the **Color Pixel Format**.\n\n```swift\npublic struct BasicRenderPipelineDescriptor: RenderPipelineDescriptor{\n    ...\n\n    init(){\n\n        ...\n\n        // make the pixel format match the device\n        renderPipelineDescriptor.colorAttachments[0].pixelFormat = Preferences.PixelFormat\n        renderPipelineDescriptor.depthAttachmentPixelFormat = Preferences.DepthStencilPixelFormat\n\n        ...\n    }\n}\n```\n\n```swift\nclass GameView: MTKView {\n\n    var renderer: GameViewRenderer!\n\n    required init(coder: NSCoder) {\n        super.init(coder: coder)\n\n        device = MTLCreateSystemDefaultDevice()\n        clearColor = Preferences.ClearColor\n        colorPixelFormat = Preferences.PixelFormat\n        depthStencilPixelFormat = Preferences.DepthStencilPixelFormat\n\n        Engine.initialize(device: device!)\n\n        renderer = GameViewRenderer(self)\n        delegate = renderer\n    }\n}\n```\n\n---\n\n## Mesh Renderer\n\nThe mesh renderer will pass the **Depth Stencil State** to the **Render Command Encoder**.\n\n```swift\nfunc doRender(renderCommandEncoder: MTLRenderCommandEncoder) {\n    ...\n    renderCommandEncoder.setDepthStencilState(DepthStencilStateCache.getDepthStencilState(.Less))\n    ...\n}\n```\n\n---\n\n## Camera\n\nThe camera will use its properties to calculate the **Perspective Projection Matrix**.\n\n```swift\nclass Camera : Component, EarlyUpdatable {\n\n    public var viewMatrix: float4x4 = matrix_identity_float4x4\n    public var projectionMatrix: float4x4 = matrix_identity_float4x4\n\n    public var type: CameraType = CameraType.Perspective\n\n    public var fieldOfView: Float = 60\n    public var nearClippingDistance: Float = 0.1\n    public var farClippingDistance: Float = 1000\n\n    ...\n\n    func updateProjectionMatrix() {\n        var result: float4x4 = matrix_identity_float4x4\n\n        if(type == CameraType.Perspective) {\n            result.projectPerspective(\n                fieldOfViewDegrees: fieldOfView,\n                aspectRatio: GameViewRenderer.AspectRatio,\n                farClippingDistance: farClippingDistance,\n                nearClippingDistance: nearClippingDistance\n            )\n        }\n\n        projectionMatrix = result\n    }\n\n    // to ensure all other components get the accurate camera position\n    func doEarlyUpdate(deltaTime: Float) {\n        updateViewMatrix()\n        updateProjectionMatrix()\n    }\n}\n```\n\n---\n\n## Scene\n\nThe Scene will include the **projection matrix** in its **Scene Constants** that will get passed down to the **GPU**.\n\n```swift\nclass Scene : Transform {\n\n    private var _sceneConstants: SceneConstants! = SceneConstants()\n\n    ...\n\n    func updateSceneConstants() {\n        _sceneConstants.viewMatrix = CameraManager.mainCamera.viewMatrix\n        _sceneConstants.projectionMatrix = CameraManager.mainCamera.projectionMatrix\n    }\n\n    override func render(renderCommandEncoder: MTLRenderCommandEncoder) {\n\n        updateSceneConstants()\n\n        // set the view matrix\n        renderCommandEncoder.setVertexBytes(\u0026_sceneConstants, length: SceneConstants.stride, index: 2)\n\n        super.render(renderCommandEncoder: renderCommandEncoder)\n    }\n}\n```\n\n---\n\n## Shader\n\nIn the Shader code, we will use the **projection matrix** to multiply it by the rest of the matrices and the position, to complete the transformation of the coordinates into **homogenous clip space**.\n\n```c\nfloat4 HCPosition = ProjMatrix * ViewMatrix * ModelMatrix * objectPosition;\n```\n\n```swift\nstruct SceneConstants {\n    float4x4 viewMatrix;\n    float4x4 projectionMatrix;\n};\n\nvertex FragmentData basic_vertex_shader(\n  // metal can infer the data because we are describing it using the vertex descriptor\n  const VertexData IN [[ stage_in ]],\n  constant ModelConstants \u0026modelConstants [[ buffer(1) ]],\n  constant SceneConstants \u0026sceneConstants [[ buffer(2) ]]\n){\n    FragmentData OUT;\n\n    // return the vertex position in homogeneous screen space\n    // ProjectionMatrix * ViewMatrix * ModelMatrix * ObjectPosition = HSCPosition\n    OUT.position = sceneConstants.projectionMatrix\n                    * sceneConstants.viewMatrix\n                    * modelConstants.modelMatrix\n                    * float4(IN.position, 1);\n\n    OUT.color = IN.color;\n\n    return OUT;\n}\n```\n\n---\n\n## Result\n\nNow the cube appears projected correctly in the screen space plane.\n\n![Picture](/images/blog/metal-render-pipeline-part-11-3d-perspective-projection-matrix/cover.jpg)\n"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"metal-render-pipeline-part-11-3d-perspective-projection-matrix"},"buildId":"wvZXsXRVXQrHYwWRs-6Uo","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Metal Render Pipeline Part 16: Lighting, Ambient, Diffuse and Specular</title><meta name="title" content="Metal Render Pipeline Part 16: Lighting, Ambient, Diffuse and Specular"/><meta name="description" content="Defining light objects with properties like position, color, intensity, range. Collecting and passing down to the GPU all light information. Defining standard surface values in the material, like color and glossiness. Accessing the material and lights information from the corresponding buffers in the lit fragment shader. Defining the structure of the mathematical model of Phong shading. Calculating ambient illumination using the color, intensity and attenuation. Calculating the diffuse using the dot product between the normals and the light direction. Calculating the specular by refracting the light direction along the normals, and doing the dot product by the direction to the camera."/><meta property="og:type" content="website"/><meta property="og:url" content="https://z4gon.github.io/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular"/><meta property="og:title" content="Metal Render Pipeline Part 16: Lighting, Ambient, Diffuse and Specular"/><meta property="og:description" content="Defining light objects with properties like position, color, intensity, range. Collecting and passing down to the GPU all light information. Defining standard surface values in the material, like color and glossiness. Accessing the material and lights information from the corresponding buffers in the lit fragment shader. Defining the structure of the mathematical model of Phong shading. Calculating ambient illumination using the color, intensity and attenuation. Calculating the diffuse using the dot product between the normals and the light direction. Calculating the specular by refracting the light direction along the normals, and doing the dot product by the direction to the camera."/><meta property="og:image" content="https://z4gon.github.io/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/cover.jpg"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:url" content="https://z4gon.github.io/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular"/><meta property="twitter:title" content="Metal Render Pipeline Part 16: Lighting, Ambient, Diffuse and Specular"/><meta property="twitter:description" content="Defining light objects with properties like position, color, intensity, range. Collecting and passing down to the GPU all light information. Defining standard surface values in the material, like color and glossiness. Accessing the material and lights information from the corresponding buffers in the lit fragment shader. Defining the structure of the mathematical model of Phong shading. Calculating ambient illumination using the color, intensity and attenuation. Calculating the diffuse using the dot product between the normals and the light direction. Calculating the specular by refracting the light direction along the normals, and doing the dot product by the direction to the camera."/><meta property="twitter:image" content="https://z4gon.github.io/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/cover.jpg"/><link rel="icon" href="https://z4gon.github.io/favicon.ico"/><link rel="canonical" href="https://z4gon.github.io/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular"/><meta name="next-head-count" content="17"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/1bfb3b4d6930f464.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1bfb3b4d6930f464.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bb71d252b31868f6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bb71d252b31868f6.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-73b8966a3c579ab0.js" defer=""></script><script src="/_next/static/chunks/main-69a178ab7f70753f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-87bdc82b6a84bda5.js" defer=""></script><script src="/_next/static/chunks/151-f9c9b99fd8f3d05e.js" defer=""></script><script src="/_next/static/chunks/358-df82d8913b69c29e.js" defer=""></script><script src="/_next/static/chunks/770-ce5b54d15e827716.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-5a3d5f8432dd744d.js" defer=""></script><script src="/_next/static/1GVYPmpjhuRyY7KdaoBJz/_buildManifest.js" defer=""></script><script src="/_next/static/1GVYPmpjhuRyY7KdaoBJz/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,500;0,700;1,300;1,500&display=swap">@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memQYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWq8tWZ0Pw86hd0Rk5hkaVQ.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memQYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWq8tWZ0Pw86hd0Rk_RkaVQ.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsiH0C4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjr0C4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsg-1y4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtE6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWvU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWu06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWt06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuU6FxZCJgg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtE6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWvU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtU6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWu06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWtk6FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWt06FxZCJgvAQ.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:italic;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memtYaGs126MiZpBA-UFUIcVXSCEkx2cmqvXlWqWuU6FxZCJgg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:300;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="Page_page__0A7TG"><nav class="NavBar_navbar__W8B89"><ul class="NavBar_links__s6P8N"><li><a class="NavBar_titleLink__OtPh0" href="/"><h1>Gonzalo Cumini</h1></a></li><li class="NavBar_secondaryLink__TpgXh"><a href="/"><h1>Portfolio</h1></a></li><li class="NavBar_secondaryLink__TpgXh"><a href="/blog"><h1>Blog</h1></a></li></ul><ul class="NavBar_icons__Q_6kO"><li class="NavBar_icon__MjYq8"><a href="https://linkedin.com/in/gonzacn" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li><li class="NavBar_icon__MjYq8"><a href="https://github.com/z4gon" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li></ul></nav><main class="Container_container__B4HQR Container_narrow__Miio9"><div style="padding-top:3.5em"></div><article><div class="PostHeader_postHeader__aw96i"><h1 class="PostTitle_postTitle__oD_V4">Metal Render Pipeline Part 16: Lighting, Ambient, Diffuse and Specular</h1><div class="PostHeader_authorAndDate__tbJVE"><div class="Avatar_avatar__G9F0L"><img src="/images/avatars/z4gon.jpg" alt="Gonzalo Cumini"/><div class="Avatar_name__yGpBe">Gonzalo Cumini</div></div><time class="DateFormatter_dateFormatter__UBCZJ" dateTime="2023-01-05T00:00:00.000Z">January	5, 2023</time></div><video muted="" playsinline="" controls="" class="PostHeader_coverVideo__CTucm"><source src="/videos/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/1.mp4" type="video/mp4"/></video></div><div class="MarkdownContent_markdownContent__TdwXL"><h2 id="source-code">Source Code</h2>
<p><a href="https://github.com/z4gon/metal-render-pipeline">See Project in GitHub üë©‚Äçüíª</a></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.youtube.com/playlist?list=PLEXt1-oJUa4BVgjZt9tK2MhV_DW7PVDsg">Metal Render Pipeline tutorial series by Rick Twohy</a></li>
<li><a href="https://stackoverflow.com/questions/59010429/what-the-purpose-of-declaring-a-variable-with-const-constant">MSL: const, constant and device</a></li>
<li><a href="https://stackoverflow.com/questions/2094666/pointers-in-c-when-to-use-the-ampersand-and-the-asterisk">C arrays behave as pointers</a></li>
<li><a href="https://www.programiz.com/c-programming/c-pointers">C Pointers</a></li>
</ul>
<h2 id="table-of-content">Table of Content</h2>
<ul>
<li><a href="#light-component">Light Component</a></li>
<li><a href="#light-data">Light Data</a></li>
<li><a href="#light-manager">Light Manager</a></li>
<li><a href="#scene">Scene</a></li>
<li><a href="#material">Material</a></li>
<li><a href="#material-data">Material Data</a></li>
<li><a href="#lit-shader">Lit Shader</a>
<ul>
<li><a href="#attenuation">Attenuation</a></li>
<li><a href="#ambient">Ambient</a></li>
<li><a href="#diffuse">Diffuse</a></li>
<li><a href="#specular">Specular</a></li>
</ul>
</li>
<li><a href="#result">Result</a></li>
</ul>
<hr/>
<h2 id="light-component">Light Component</h2>
<p>Will be in charge of keeping the <strong>position</strong> of the <strong>light</strong>, by reusing the <strong>transform object</strong>.
Also generates the <strong>Light Data</strong> whenever requested.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">enum</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightType</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">case</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Point</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">case</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Directional</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span></span><span class="token" style="color:rgb(127, 219, 202)">class</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Light</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Component</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> type</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightType</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightType</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(255, 203, 139)">Point</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">10</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> intensity</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">1</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">11</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> ambient</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0.3</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">12</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> float4 </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Colors</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(255, 203, 139)">White</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">14</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> range</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0.6</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">15</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">16</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">private</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> _data</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">17</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> data</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span class="token" style="color:rgb(127, 219, 202)">!</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">19</span><span>        _data</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>position </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> gameObject</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>position
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">20</span><span>        _data</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>color </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> color
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">21</span><span>        _data</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>intensity </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> intensity
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">22</span><span>        _data</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>ambient </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> ambient
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">23</span><span>        _data</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>range </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> range
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">24</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">25</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">return</span><span> _data
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">26</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">27</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<hr/>
<h2 id="light-data">Light Data</h2>
<p>Is just a <strong>struct</strong> that can be passed down to the <strong>GPU</strong> with the relevant <strong>Light information</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">struct</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> sizeable </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> position</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> float3 </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">float3</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>repeating</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> float4 </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Colors</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(255, 203, 139)">White</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> intensity</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">1</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> ambient</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0.3</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> range</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0.6</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<p>The <strong>GPU</strong> will also define a struct to access the data from the <strong>buffer</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">struct</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    float3 position</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>    float4 color</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> intensity</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> ambient</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> range</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span><span class="token" style="color:rgb(199, 146, 234)">;</span></code></div></pre>
<hr/>
<h2 id="light-manager">Light Manager</h2>
<p>Each time a <strong>light component</strong> is added to a <strong>game object</strong>, the <strong>light manager</strong> keeps track of it.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">class</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">GameObject</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Transform</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">private</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> _components</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(255, 203, 139)">Component</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(127, 219, 202)">!</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">func</span><span> </span><span class="token function-definition" style="color:rgb(130, 170, 255)">addComponent</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token omit" style="color:rgb(127, 219, 202)">_</span><span> component</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Component</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>        _components</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">append</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>component</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>        component</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">setGameObject</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(127, 219, 202)">self</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span><span>        </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// set the camera as the main camera</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">9</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">if</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">let</span><span> camera  </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> component </span><span class="token" style="color:rgb(127, 219, 202)">as</span><span class="token" style="color:rgb(127, 219, 202)">?</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Camera</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">10</span><span>            </span><span class="token" style="color:rgb(255, 203, 139)">CameraManager</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>mainCamera </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> camera
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">11</span><span>        </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">12</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">13</span><span>        </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// keep track of the lights</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">14</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">if</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">let</span><span> light  </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> component </span><span class="token" style="color:rgb(127, 219, 202)">as</span><span class="token" style="color:rgb(127, 219, 202)">?</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Light</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">15</span><span>            </span><span class="token" style="color:rgb(255, 203, 139)">LightManager</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">addLight</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>light</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">16</span><span>        </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">17</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">18</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<p>The <strong>Light Manager</strong> is in charge of generating the <strong>buffer</strong> with all the <strong>Light Data</strong>.</p>
<p>It&#x27;s very inefficient to do this on each cycle, but for siplicity we will keep it like this for now.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">class</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightManager</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">static</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> lightsBuffer</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MTLBuffer</span><span class="token" style="color:rgb(127, 219, 202)">?</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">if</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>_lights</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>count </span><span class="token" style="color:rgb(127, 219, 202)">==</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">return</span><span> </span><span class="token nil" style="color:rgb(130, 170, 255)">nil</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>        _lightDatas </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">for</span><span> light </span><span class="token" style="color:rgb(127, 219, 202)">in</span><span> _lights </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span><span>            _lightDatas</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">append</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>data</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span><span>        </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">10</span><span>        </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// ineficcient, but will do for now</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">11</span><span>        </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// we need an updated position of the lights</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">12</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">return</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Engine</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>device</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">makeBuffer</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>bytes</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> _lightDatas</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> length</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>stride </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> _lightDatas</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>count </span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> options</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">13</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">15</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">static</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> lightsCount</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Int</span><span class="token" style="color:rgb(127, 219, 202)">!</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">16</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">return</span><span> _lights</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>count
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">17</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">19</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">private</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">static</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> _lightDatas</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(255, 203, 139)">LightData</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(127, 219, 202)">!</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">20</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">private</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">static</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> _lights</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(255, 203, 139)">Light</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(127, 219, 202)">!</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">21</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">private</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">static</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> _lightsBuffer</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MTLBuffer</span><span class="token" style="color:rgb(127, 219, 202)">!</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">22</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">23</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">static</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">func</span><span> </span><span class="token function-definition" style="color:rgb(130, 170, 255)">addLight</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token omit" style="color:rgb(127, 219, 202)">_</span><span> light</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Light</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">24</span><span>        _lights</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">append</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>light</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">25</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">26</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<hr/>
<h2 id="scene">Scene</h2>
<p>Now also sets the <strong>Light Data</strong> buffer whenever there are lights on the <strong>scene</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">override</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">func</span><span> </span><span class="token function-definition" style="color:rgb(130, 170, 255)">render</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>    </span><span class="token" style="color:rgb(130, 170, 255)">updateSceneConstants</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>    </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// set the view matrix and projection matrix</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>    </span><span class="token" style="color:rgb(255, 203, 139)">Graphics</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>renderCommandEncoder</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">setVertexBytes</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(127, 219, 202)">&amp;</span><span>_sceneConstants</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> length</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">SceneConstants</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>stride</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> index</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span><span>    </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// set light data</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">9</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">if</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightManager</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>lightsCount </span><span class="token" style="color:rgb(127, 219, 202)">&gt;</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">10</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> lightsCount </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">LightManager</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>lightsCount
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">11</span><span>        </span><span class="token" style="color:rgb(255, 203, 139)">Graphics</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>renderCommandEncoder</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">setFragmentBuffer</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(255, 203, 139)">LightManager</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>lightsBuffer</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> offset</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> index</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">1</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">12</span><span>        </span><span class="token" style="color:rgb(255, 203, 139)">Graphics</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>renderCommandEncoder</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">setFragmentBytes</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(127, 219, 202)">&amp;</span><span>lightsCount</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> length</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Int32</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>stride</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> index</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">13</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">15</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">super</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">render</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">16</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<hr/>
<h2 id="material">Material</h2>
<p>Materials now also have some common <strong>surface properties</strong>, like <strong>color</strong> and <strong>glossiness</strong>.
In the future they can also have <strong>standard surface properties</strong> like <strong>emission</strong>, <strong>metallic</strong>, <strong>albedo</strong>, <strong>normal maps</strong>, etc.</p>
<p>By default, <strong>Materials</strong> set their <strong>values</strong> to the <strong>GPU</strong> in the <strong>fragment buffer 0</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">class</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Material</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> materialData</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MaterialData</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MaterialData</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> vertexFunctionName</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">String</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">VertexFunctionNames</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(255, 203, 139)">Basic</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> fragmentFunctionName</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">String</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">FragmentFunctionNames</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(255, 203, 139)">VertexColor</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> renderPipelineStateId</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">String</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span><span>        </span><span class="token" style="color:rgb(127, 219, 202)">return</span><span> </span><span class="token string-literal" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string-literal interpolation-punctuation" style="color:rgb(199, 146, 234)">\(</span><span class="token string-literal interpolation">vertexFunctionName</span><span class="token string-literal interpolation-punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token string-literal" style="color:rgb(173, 219, 103)">/</span><span class="token string-literal interpolation-punctuation" style="color:rgb(199, 146, 234)">\(</span><span class="token string-literal interpolation">fragmentFunctionName</span><span class="token string-literal interpolation-punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token string-literal" style="color:rgb(173, 219, 103)">&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">9</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">11</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">func</span><span> </span><span class="token function-definition" style="color:rgb(130, 170, 255)">setColor</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token omit" style="color:rgb(127, 219, 202)">_</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> float4</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">12</span><span>        materialData</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>color </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> color
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">13</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">15</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">func</span><span> </span><span class="token function-definition" style="color:rgb(130, 170, 255)">setGlossiness</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token omit" style="color:rgb(127, 219, 202)">_</span><span> glossiness</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">16</span><span>        materialData</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>glossiness </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> glossiness
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">17</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">19</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">func</span><span> </span><span class="token function-definition" style="color:rgb(130, 170, 255)">setGpuValues</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">20</span><span>        </span><span class="token" style="color:rgb(255, 203, 139)">Graphics</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>renderCommandEncoder</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">setFragmentBytes</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(127, 219, 202)">&amp;</span><span>materialData</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> length</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MaterialData</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>stride</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> index</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">21</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">22</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<hr/>
<h2 id="material-data">Material Data</h2>
<p>Is just a <strong>struct</strong> that can be passed down to the <strong>GPU</strong> with the relevant <strong>Material values</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-swift" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">struct</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MaterialData</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> sizeable </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> float4 </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Colors</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(255, 203, 139)">White</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">public</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">var</span><span> glossiness</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">Float</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<p>The <strong>GPU</strong> will also define a struct to access the data from the <strong>buffer</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(127, 219, 202)">struct</span><span> </span><span class="token" style="color:rgb(255, 203, 139)">MaterialData</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    float4 color</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> glossiness</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span><span class="token" style="color:rgb(199, 146, 234)">;</span></code></div></pre>
<hr/>
<h2 id="lit-shader">Lit Shader</h2>
<p>The <strong>general structure</strong> of the <strong>lit shader</strong> that <strong>samples textures</strong> will be like below.
It takes in the <strong>material properties</strong> to access the <strong>glossiness</strong> for the <strong>specular calculation</strong>.
The <strong>lights</strong> will come in an array, each with their poisition and other relevant data.</p>
<p>The <strong>fragment shader</strong> will also have access to <strong>the camera position</strong>, and the <strong>normals</strong> of the fragments.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span>fragment half4 </span><span class="token" style="color:rgb(130, 170, 255)">lit_texture_sample_fragment_shader</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">const</span><span> FragmentData IN </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span> stage_in </span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span>    constant MaterialData </span><span class="token" style="color:rgb(127, 219, 202)">&amp;</span><span> materialData </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">buffer</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>    constant LightData </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> lights </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">buffer</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(247, 140, 108)">1</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span><span>    constant </span><span class="token" style="color:rgb(127, 219, 202)">int</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">&amp;</span><span> lightsCount </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">buffer</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(247, 140, 108)">2</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">9</span><span>    </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// sampler and texture2d coming in their corresponding memory blocks</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">10</span><span>    sampler sampler2d </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">sampler</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">11</span><span>    texture2d</span><span class="token" style="color:rgb(127, 219, 202)">&lt;</span><span class="token" style="color:rgb(127, 219, 202)">float</span><span class="token" style="color:rgb(127, 219, 202)">&gt;</span><span> texture </span><span class="token" style="color:rgb(199, 146, 234)">[</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">texture</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">12</span><span></span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">13</span><span>    </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// sample texture</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">14</span><span>    float4 color </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> texture</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span class="token" style="color:rgb(130, 170, 255)">sample</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>sampler2d</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> IN</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>uv</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">15</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">16</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">for</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(127, 219, 202)">int</span><span> i </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span> i </span><span class="token" style="color:rgb(127, 219, 202)">&lt;</span><span> lightsCount</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span> i</span><span class="token" style="color:rgb(127, 219, 202)">++</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">17</span><span>        LightData light </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> lights</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span>i</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">19</span><span>        </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// TODO: CALCULATE PHONG LIGHTING</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">20</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">21</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">22</span><span>    float4 phong </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> totalAmbient </span><span class="token" style="color:rgb(127, 219, 202)">+</span><span> totalDiffuse </span><span class="token" style="color:rgb(127, 219, 202)">+</span><span> totalSpecular</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">23</span><span>    color </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> color </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> phong</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">24</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">25</span><span>    </span><span class="token" style="color:rgb(127, 219, 202)">return</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">half4</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>color</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>r</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>g</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>b</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> color</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>a</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">26</span><span></span><span class="token" style="color:rgb(199, 146, 234)">}</span></code></div></pre>
<h3 id="attenuation">Attenuation</h3>
<p>We calculate a <strong>linear attenuation</strong> to make the light <strong>intensity fade away</strong> the farther away we are from the light, given a <strong>range</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span>LightData light </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> lights</span><span class="token" style="color:rgb(199, 146, 234)">[</span><span>i</span><span class="token" style="color:rgb(199, 146, 234)">]</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span></span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// light direction</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span>float4 lightDir </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">float4</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>position</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>xyz</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">1</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">-</span><span> IN</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>worldPosition</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span></span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// attenuation</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">7</span><span></span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> distanceToLight </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">length</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>lightDir</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">8</span><span></span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> attenuation </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">1</span><span> </span><span class="token" style="color:rgb(127, 219, 202)">-</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">clamp</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>distanceToLight</span><span class="token" style="color:rgb(127, 219, 202)">/</span><span>light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>range</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0.0</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">1.0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span></code></div></pre>
<h3 id="ambient">Ambient</h3>
<p>The <strong>ambient</strong> is calculated using the <strong>ambient intensity</strong> of the <strong>light</strong>, its <strong>color</strong> and the <strong>attenuation</strong>.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// ambient</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>float4 ambient </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>color </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>ambient </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> attenuation</span><span class="token" style="color:rgb(199, 146, 234)">;</span></code></div></pre>
<p><img src="/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/1.jpg" alt="Picture"/></p>
<h3 id="diffuse">Diffuse</h3>
<p>The <strong>diffuse</strong> is calculated by doing the <strong>DOT product</strong> between the <strong>surface normal</strong> and the <strong>light direction</strong> vector.
The more the <strong>surface</strong> is to a <strong>90 degree to the light direction</strong>, or past it <strong>facing away from the light</strong>, the <strong>darker</strong> it&#x27;s going to be.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// diffuse</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span></span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> nDotL </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">max</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(130, 170, 255)">dot</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(130, 170, 255)">normalize</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>IN</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>worldNormal</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">normalize</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>lightDir</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">0.0</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>float4 diffuse </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span>  light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>color </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> nDotL </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>intensity </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> attenuation</span><span class="token" style="color:rgb(199, 146, 234)">;</span></code></div></pre>
<p><img src="/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/2.jpg" alt="Picture"/></p>
<h3 id="specular">Specular</h3>
<p>The <strong>specular</strong> is calculated by <strong>reflecting</strong> the <strong>light direction</strong> by the <strong>surface normal vector</strong>.
Then doing the <strong>DOT product</strong> between the <strong>reflected light direction</strong> and the <strong>view direction</strong>.</p>
<p>The more the rays are pointing to the camera, the brighter.</p>
<p>Finally we do a <strong>power</strong> by the <strong>glossiness</strong> defined in the <strong>material</strong>, the more glossiness, the <strong>sharper</strong> the <strong>reflections</strong> will be.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-c" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">1</span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// specular</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">2</span><span>float3 viewDir </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> IN</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>cameraPosition </span><span class="token" style="color:rgb(127, 219, 202)">-</span><span> IN</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>worldPosition</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>xyz</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">3</span><span>float3 reflectedLightDir </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">reflect</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(127, 219, 202)">-</span><span class="token" style="color:rgb(130, 170, 255)">normalize</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>lightDir</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>xyz</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">normalize</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>IN</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>worldNormal</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>xyz</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">4</span><span></span><span class="token" style="color:rgb(127, 219, 202)">float</span><span> vDotL </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">max</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span class="token" style="color:rgb(247, 140, 108)">0.0</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">dot</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>reflectedLightDir</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">normalize</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>viewDir</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span> </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">// avoid negative values</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">5</span><span>vDotL </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span> </span><span class="token" style="color:rgb(130, 170, 255)">pow</span><span class="token" style="color:rgb(199, 146, 234)">(</span><span>vDotL</span><span class="token" style="color:rgb(199, 146, 234)">,</span><span> materialData</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>glossiness</span><span class="token" style="color:rgb(199, 146, 234)">)</span><span class="token" style="color:rgb(199, 146, 234)">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:rgb(99, 119, 119);font-style:italic">6</span><span>float4 specular </span><span class="token" style="color:rgb(127, 219, 202)">=</span><span>  light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>color </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> vDotL </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> light</span><span class="token" style="color:rgb(199, 146, 234)">.</span><span>intensity </span><span class="token" style="color:rgb(127, 219, 202)">*</span><span> attenuation</span><span class="token" style="color:rgb(199, 146, 234)">;</span></code></div></pre>
<p><img src="/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/3.jpg" alt="Picture"/></p>
<hr/>
<h2 id="result">Result</h2>
<p>The <strong>3D model of Samus</strong> is now correclty illuminated with <strong>ambient</strong>, <strong>diffuse</strong> and <strong>specular</strong> components.</p>
<p><img src="/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/cover.jpg" alt="Picture"/>
<img src="/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/5.jpg" alt="Picture"/></p></div></article><div style="padding-top:3.5em"></div></main><footer class="Footer_footer__rEL09"><p>¬©<!-- --> 2023, Gonzalo Cumini</p><ul class="Footer_icons__IyNdc"><li class="Footer_icon__mhtwE"><a href="https://linkedin.com/in/gonzacn" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li><li class="Footer_icon__mhtwE"><a href="https://github.com/z4gon" rel="noopener noreferrer" target="_blank"><svg class="IconLink_iconSvg__kq2nE" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li></ul></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular","date":"2023-01-05T00:00:00.000Z","author":{"name":"Gonzalo Cumini","pictureUrl":"/images/avatars/z4gon.jpg"},"title":"Metal Render Pipeline Part 16: Lighting, Ambient, Diffuse and Specular","excerpt":"Defining light objects with properties like position, color, intensity, range. Collecting and passing down to the GPU all light information. Defining standard surface values in the material, like color and glossiness. Accessing the material and lights information from the corresponding buffers in the lit fragment shader. Defining the structure of the mathematical model of Phong shading. Calculating ambient illumination using the color, intensity and attenuation. Calculating the diffuse using the dot product between the normals and the light direction. Calculating the specular by refracting the light direction along the normals, and doing the dot product by the direction to the camera.","coverImageUrl":"/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/cover.jpg","coverImageSourceUrl":"","coverVideoUrl":"/videos/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/1.mp4","markdownContent":"\n## Source Code\n\n[See Project in GitHub üë©‚Äçüíª](https://github.com/z4gon/metal-render-pipeline)\n\n## References\n\n- [Metal Render Pipeline tutorial series by Rick Twohy](https://www.youtube.com/playlist?list=PLEXt1-oJUa4BVgjZt9tK2MhV_DW7PVDsg)\n- [MSL: const, constant and device](https://stackoverflow.com/questions/59010429/what-the-purpose-of-declaring-a-variable-with-const-constant)\n- [C arrays behave as pointers](https://stackoverflow.com/questions/2094666/pointers-in-c-when-to-use-the-ampersand-and-the-asterisk)\n- [C Pointers](https://www.programiz.com/c-programming/c-pointers)\n\n## Table of Content\n\n- [Light Component](#light-component)\n- [Light Data](#light-data)\n- [Light Manager](#light-manager)\n- [Scene](#scene)\n- [Material](#material)\n- [Material Data](#material-data)\n- [Lit Shader](#lit-shader)\n  - [Attenuation](#attenuation)\n  - [Ambient](#ambient)\n  - [Diffuse](#diffuse)\n  - [Specular](#specular)\n- [Result](#result)\n\n---\n\n## Light Component\n\nWill be in charge of keeping the **position** of the **light**, by reusing the **transform object**.\nAlso generates the **Light Data** whenever requested.\n\n```swift\nenum LightType {\n    case Point\n    case Directional\n}\n\nclass Light : Component {\n\n    public var type: LightType = LightType.Point\n\n    public var intensity: Float = 1\n    public var ambient: Float = 0.3\n    public var color: float4 = Colors.White\n\n    public var range: Float = 0.6\n\n    private var _data: LightData = LightData()\n    public var data: LightData! {\n\n        _data.position = gameObject.position\n        _data.color = color\n        _data.intensity = intensity\n        _data.ambient = ambient\n        _data.range = range\n\n        return _data\n    }\n}\n```\n\n---\n\n## Light Data\n\nIs just a **struct** that can be passed down to the **GPU** with the relevant **Light information**.\n\n```swift\nstruct LightData: sizeable {\n    var position: float3 = float3(repeating: 0)\n    var color: float4 = Colors.White\n    var intensity: Float = 1\n    var ambient: Float = 0.3\n    var range: Float = 0.6\n}\n```\n\nThe **GPU** will also define a struct to access the data from the **buffer**.\n\n```c\nstruct LightData {\n    float3 position;\n    float4 color;\n    float intensity;\n    float ambient;\n    float range;\n};\n```\n\n---\n\n## Light Manager\n\nEach time a **light component** is added to a **game object**, the **light manager** keeps track of it.\n\n```swift\nclass GameObject : Transform {\n    private var _components: [Component]! = []\n\n    public func addComponent(_ component: Component){\n        _components.append(component)\n        component.setGameObject(self)\n\n        // set the camera as the main camera\n        if let camera  = component as? Camera {\n            CameraManager.mainCamera = camera\n        }\n\n        // keep track of the lights\n        if let light  = component as? Light {\n            LightManager.addLight(light)\n        }\n    }\n}\n```\n\nThe **Light Manager** is in charge of generating the **buffer** with all the **Light Data**.\n\nIt's very inefficient to do this on each cycle, but for siplicity we will keep it like this for now.\n\n```swift\nclass LightManager {\n    public static var lightsBuffer: MTLBuffer? {\n        if(_lights.count == 0) { return nil }\n\n        _lightDatas = []\n        for light in _lights {\n            _lightDatas.append(light.data)\n        }\n\n        // ineficcient, but will do for now\n        // we need an updated position of the lights\n        return Engine.device.makeBuffer(bytes: _lightDatas, length: LightData.stride * _lightDatas.count , options: [])\n    }\n\n    public static var lightsCount: Int! {\n        return _lights.count\n    }\n\n    private static var _lightDatas: [LightData]! = []\n    private static var _lights: [Light]! = []\n    private static var _lightsBuffer: MTLBuffer!\n\n    static func addLight(_ light: Light) {\n        _lights.append(light)\n    }\n}\n```\n\n---\n\n## Scene\n\nNow also sets the **Light Data** buffer whenever there are lights on the **scene**.\n\n```swift\noverride func render() {\n\n    updateSceneConstants()\n\n    // set the view matrix and projection matrix\n    Graphics.renderCommandEncoder.setVertexBytes(\u0026_sceneConstants, length: SceneConstants.stride, index: 2)\n\n    // set light data\n    if LightManager.lightsCount \u003e 0 {\n        var lightsCount = LightManager.lightsCount\n        Graphics.renderCommandEncoder.setFragmentBuffer(LightManager.lightsBuffer, offset: 0, index: 1)\n        Graphics.renderCommandEncoder.setFragmentBytes(\u0026lightsCount, length: Int32.stride, index: 2)\n    }\n\n    super.render()\n}\n```\n\n---\n\n## Material\n\nMaterials now also have some common **surface properties**, like **color** and **glossiness**.\nIn the future they can also have **standard surface properties** like **emission**, **metallic**, **albedo**, **normal maps**, etc.\n\nBy default, **Materials** set their **values** to the **GPU** in the **fragment buffer 0**.\n\n```swift\nclass Material {\n    public var materialData: MaterialData = MaterialData()\n\n    public var vertexFunctionName: String = VertexFunctionNames.Basic\n    public var fragmentFunctionName: String = FragmentFunctionNames.VertexColor\n\n    public var renderPipelineStateId: String {\n        return \"\\(vertexFunctionName)/\\(fragmentFunctionName)\"\n    }\n\n    func setColor(_ color: float4){\n        materialData.color = color\n    }\n\n    func setGlossiness(_ glossiness: Float){\n        materialData.glossiness = glossiness\n    }\n\n    func setGpuValues() {\n        Graphics.renderCommandEncoder.setFragmentBytes(\u0026materialData, length: MaterialData.stride, index: 0)\n    }\n}\n```\n\n---\n\n## Material Data\n\nIs just a **struct** that can be passed down to the **GPU** with the relevant **Material values**.\n\n```swift\nstruct MaterialData: sizeable {\n    public var color: float4 = Colors.White\n    public var glossiness: Float = 2\n}\n```\n\nThe **GPU** will also define a struct to access the data from the **buffer**.\n\n```c\nstruct MaterialData {\n    float4 color;\n    float glossiness;\n};\n```\n\n---\n\n## Lit Shader\n\nThe **general structure** of the **lit shader** that **samples textures** will be like below.\nIt takes in the **material properties** to access the **glossiness** for the **specular calculation**.\nThe **lights** will come in an array, each with their poisition and other relevant data.\n\nThe **fragment shader** will also have access to **the camera position**, and the **normals** of the fragments.\n\n```c\nfragment half4 lit_texture_sample_fragment_shader(\n    const FragmentData IN [[ stage_in ]],\n\n    constant MaterialData \u0026 materialData [[ buffer(0) ]],\n\n    constant LightData * lights [[ buffer(1) ]],\n    constant int \u0026 lightsCount [[ buffer(2) ]],\n\n    // sampler and texture2d coming in their corresponding memory blocks\n    sampler sampler2d [[ sampler(0) ]],\n    texture2d\u003cfloat\u003e texture [[ texture(0) ]]\n){\n    // sample texture\n    float4 color = texture.sample(sampler2d, IN.uv);\n\n    for(int i = 0; i \u003c lightsCount; i++){\n        LightData light = lights[i];\n\n        // TODO: CALCULATE PHONG LIGHTING\n    }\n\n    float4 phong = totalAmbient + totalDiffuse + totalSpecular;\n    color = color * phong;\n\n    return half4(color.r, color.g, color.b, color.a);\n}\n```\n\n### Attenuation\n\nWe calculate a **linear attenuation** to make the light **intensity fade away** the farther away we are from the light, given a **range**.\n\n```c\nLightData light = lights[i];\n\n// light direction\nfloat4 lightDir = float4(light.position.xyz, 1) - IN.worldPosition;\n\n// attenuation\nfloat distanceToLight = length(lightDir);\nfloat attenuation = 1 - clamp(distanceToLight/light.range, 0.0, 1.0);\n```\n\n### Ambient\n\nThe **ambient** is calculated using the **ambient intensity** of the **light**, its **color** and the **attenuation**.\n\n```c\n// ambient\nfloat4 ambient = light.color * light.ambient * attenuation;\n```\n\n![Picture](/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/1.jpg)\n\n### Diffuse\n\nThe **diffuse** is calculated by doing the **DOT product** between the **surface normal** and the **light direction** vector.\nThe more the **surface** is to a **90 degree to the light direction**, or past it **facing away from the light**, the **darker** it's going to be.\n\n```c\n// diffuse\nfloat nDotL = max(dot(normalize(IN.worldNormal), normalize(lightDir)), 0.0);\nfloat4 diffuse =  light.color * nDotL * light.intensity * attenuation;\n```\n\n![Picture](/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/2.jpg)\n\n### Specular\n\nThe **specular** is calculated by **reflecting** the **light direction** by the **surface normal vector**.\nThen doing the **DOT product** between the **reflected light direction** and the **view direction**.\n\nThe more the rays are pointing to the camera, the brighter.\n\nFinally we do a **power** by the **glossiness** defined in the **material**, the more glossiness, the **sharper** the **reflections** will be.\n\n```c\n// specular\nfloat3 viewDir = IN.cameraPosition - IN.worldPosition.xyz;\nfloat3 reflectedLightDir = reflect(-normalize(lightDir.xyz), normalize(IN.worldNormal.xyz));\nfloat vDotL = max(0.0, dot(reflectedLightDir, normalize(viewDir))); // avoid negative values\nvDotL = pow(vDotL, materialData.glossiness);\nfloat4 specular =  light.color * vDotL * light.intensity * attenuation;\n```\n\n![Picture](/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/3.jpg)\n\n---\n\n## Result\n\nThe **3D model of Samus** is now correclty illuminated with **ambient**, **diffuse** and **specular** components.\n\n![Picture](/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/cover.jpg)\n![Picture](/images/blog/metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular/5.jpg)\n"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"metal-render-pipeline-part-16-lighting-phong-ambient-diffuse-specular"},"buildId":"1GVYPmpjhuRyY7KdaoBJz","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>